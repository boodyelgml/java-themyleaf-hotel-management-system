<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layout.html}">

<head>
    <!-- Include jQuery library -->
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <!-- Include Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" />
    <!-- Include Bootstrap JS -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
    <!-- Include Bootstrap Selectpicker CSS -->
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/css/bootstrap-select.min.css" />
    <!-- Include Bootstrap Selectpicker JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/js/bootstrap-select.min.js"></script>
    <meta charset="UTF-8" />
    <title>نزيل جديد</title>
</head>

<body class="d-flex flex-column h-100">
    <main class="flex-shrink-0">
        <section layout:fragment="content" class="py-3" style="min-height: 100vh">
            <div class="container">


                <div class="row text-right">


                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header text-center text-primary font-weight-bold">
                                تفاصيل الإقامة
                            </div>
                            <div class="card-body ">

                                <form id="reservationForm" th:action="@{/submitReservation}" method="post">
                                    <input type="hidden" id="guestId" name="guestId" th:value="${guestId}" />
                                    <input type="hidden" id="roomId" name="roomId" th:value="${roomId}" />
                                    <div class="row ">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="endedAt">وقت المغادرة</label>
                                                <input type="datetime-local" class="form-control text-right "
                                                    id="endedAt" name="endedAt" required />
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="startedAt">وقت الدخول</label>
                                                <input type="datetime-local" class="form-control text-right"
                                                    id="startedAt" name="startedAt" required />
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="details">التفاصيل</label>
                                        <textarea class="form-control text-right " id="details"
                                            name="details"></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label for="saves">الأمانات</label>
                                        <textarea class="form-control text-right " id="saves" name="saves"></textarea>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="advanceAmount">المبلغ المدفوع</label>
                                                <input type="number" class="form-control text-right" id="advanceAmount"
                                                    name="advanceAmount" required />
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="dueAmount">المبلغ المستحق</label>
                                                <input type="number" class="form-control text-right" id="dueAmount"
                                                    name="dueAmount" required />
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="remainsAmount">المبلغ المتبقى</label>
                                        <input type="number" class="form-control text-right" id="remainsAmount"
                                            name="remainsAmount" readonly />
                                    </div>
                                    <div class="remainsAmountErrors text-sm my-2" style="color:red; font-size:smaller">
                                        لايمكن ان يكون المبلغ المتبقى بالقيمة السالبة
                                    </div>
                                    <div class="form-group">
                                        <button type="button" class="btn btn-primary submitBtn">
                                            حفظ
                                        </button>
                                    </div>

                                </form>
                            </div>
                        </div>

                    </div>






                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header text-center text-primary font-weight-bold">
                                بيانات النزيل
                            </div>
                            <div class="card-body">
                                <form id="userForm">

                                    <!-- National ID input -->
                                    <div class="form-group">
                                        <input placeholder="الرقم القومى للعميل" type="number"
                                            class="form-control nationalId text-right" id="nationalId" name="nationalId"
                                            maxlength="14" />
                                        <div class="nationalIdErrors text-sm my-2" style="color:red; font-size:smaller">
                                            يجب أن يكون الرقم القومى مكون من 14 رقم
                                        </div>
                                    </div>

                                    <!-- Name input -->
                                    <div class="form-group mt-2">
                                        <input placeholder="أسم العميل" type="text" class="form-control text-right"
                                            id="name" name="name" />
                                        <div class="nameErrors text-sm" style="color:red; font-size:smaller">
                                            الأسم يجب أن يكون حروف فقط و اكبر من 4 حروف و أقل من 100 حرف
                                        </div>
                                    </div>

                                    <!-- Mobile Number input -->
                                    <div class="form-group">
                                        <input placeholder="رقم الهاتف" type="text" class="form-control text-right"
                                            id="mobileNumber" name="mobileNumber" />
                                        <div class="mobileNumberErrors text-sm" style="color:red; font-size:smaller">
                                            رقم الموبايل يجب أن يكون 11 رقم
                                        </div>
                                    </div>

                                    <!-- Email input -->
                                    <div class="form-group">
                                        <input placeholder="البريد الإلكترونى" type="text"
                                            class="form-control text-right" id="email" name="email" />
                                        <div class="emailErrors text-sm" style="color:red; font-size:smaller">
                                            ايميل غير صحيح
                                        </div>
                                    </div>

                                    <!-- Marital Status input -->
                                    <div class="form-group">
                                        <label for="age">الحالة الإجتماعية</label>
                                        <select placeholder="الحالة الإجتماعية" class="form-control text-right"
                                            id="maritalStatus" name="maritalStatus">
                                            <option value="married">متزوج</option>
                                            <option value="single">أعزب</option>
                                        </select>
                                    </div>

                                    <!-- Age input -->
                                    <!-- Age input -->
                                    <div class="form-group">
                                        <label for="age">العمر</label>
                                        <select class="form-control text-right" id="age" name="age">
                                            <option value="18">18</option>
                                            <option value="19">19</option>
                                            <option value="20">20</option>
                                            <option value="21">21</option>
                                            <option value="22">22</option>
                                            <option value="23">23</option>
                                            <option value="24">24</option>
                                            <option value="25" selected>25</option>
                                            <option value="26">26</option>
                                            <option value="27">27</option>
                                            <option value="28">28</option>
                                            <option value="29">29</option>
                                            <option value="30">30</option>
                                            <option value="31">31</option>
                                            <option value="32">32</option>
                                            <option value="33">33</option>
                                            <option value="34">34</option>
                                            <option value="35">35</option>
                                            <option value="36">36</option>
                                            <option value="37">37</option>
                                            <option value="38">38</option>
                                            <option value="39">39</option>
                                            <option value="40">40</option>
                                            <option value="41">41</option>
                                            <option value="42">42</option>
                                            <option value="43">43</option>
                                            <option value="44">44</option>
                                            <option value="45">45</option>
                                            <option value="46">46</option>
                                            <option value="47">47</option>
                                            <option value="48">48</option>
                                            <option value="49">49</option>
                                            <option value="50">50</option>
                                            <option value="51">51</option>
                                            <option value="52">52</option>
                                            <option value="53">53</option>
                                            <option value="54">54</option>
                                            <option value="55">55</option>
                                            <option value="56">56</option>
                                            <option value="57">57</option>
                                            <option value="58">58</option>
                                            <option value="59">59</option>
                                            <option value="60">60</option>
                                            <option value="61">61</option>
                                            <option value="62">62</option>
                                            <option value="63">63</option>
                                            <option value="64">64</option>
                                            <option value="65">65</option>
                                            <option value="66">66</option>
                                            <option value="67">67</option>
                                            <option value="68">68</option>
                                            <option value="69">69</option>
                                            <option value="70">70</option>
                                            <option value="71">71</option>
                                            <option value="72">72</option>
                                            <option value="73">73</option>
                                            <option value="74">74</option>
                                            <option value="75">75</option>
                                            <option value="76">76</option>
                                            <option value="77">77</option>
                                            <option value="78">78</option>
                                            <option value="79">79</option>
                                            <option value="80">80</option>
                                            <option value="81">81</option>
                                            <option value="82">82</option>
                                            <option value="83">83</option>
                                            <option value="84">84</option>
                                            <option value="85">85</option>
                                            <option value="86">86</option>
                                            <option value="87">87</option>
                                            <option value="88">88</option>
                                            <option value="89">89</option>
                                            <option value="90">90</option>
                                            <option value="91">91</option>
                                            <option value="92">92</option>
                                            <option value="93">93</option>
                                            <option value="94">94</option>
                                            <option value="95">95</option>
                                            <option value="96">96</option>
                                            <option value="97">97</option>
                                            <option value="98">98</option>
                                            <option value="99">99</option>
                                        </select>
                                    </div>


                                    <!-- Submit button -->
                                    <div class="form-group">
                                        <button type="button" class="btn btn-primary submitGuestBtn">
                                            حفظ
                                        </button>
                                    </div>
                                </form>

                            </div>
                        </div>
                    </div>




                </div>

        </section>
    </main>
    <!-- Script for AJAX form submission -->
    <script layout:fragment="custom-scripts">
        $(document).ready(function () {

            $('.submitBtn').prop('disabled', true);

            isDatesValid = false;
            isMoneyValid = false;

            var currentDate = new Date().toISOString().slice(0, 16);
            $('#startedAt').attr('min', currentDate);

            $('#startedAt').on('change', function () {
                $('#endedAt').prop("disabled", false);
                var startedAtValue = $(this).val();
                $('#endedAt').attr('min', startedAtValue);
            });

            $('.remainsAmountErrors').hide();
            $("#advanceAmount , #dueAmount").on("keyup", function () {
                var dueAmount = parseFloat($("#dueAmount").val()) || 0;
                var advanceAmount = parseFloat($("#advanceAmount").val()) || 0;
                $("#remainsAmount").val(dueAmount - advanceAmount);
                if ($("#remainsAmount").val(dueAmount - advanceAmount).val() < 0) {
                    $('.remainsAmountErrors').show();
                } else {
                    $('.remainsAmountErrors').hide();
                }
            });


            $('#dueAmount').on('keyup', function () {
                if ($(this).val() >= 0) {
                    $('#advanceAmount').prop("disabled", false);
                } else {
                    $('#advanceAmount').val(null)
                    $('#advanceAmount').prop("disabled", true);
                }
            });


            $("#reservationForm input").on("keyup", function () {
                var dueAmount = parseFloat($("#dueAmount").val()) || 0;
                var advanceAmount = parseFloat($(this).val()) || 0;

                if ((advanceAmount <= dueAmount) && ($('#startedAt').val())) {
                    $('.submitBtn').prop('disabled', false);
                } else {
                    $('.submitBtn').prop('disabled', true);
                }
            });

            $(".submitBtn").on("click", function () {
                var formData = new FormData($('#reservationForm')[0]);
                formData.forEach(function (value, key) {
                    console.log(key, value);
                });
                $.ajax({
                    type: "POST",
                    url: "/submitReservation",
                    data: formData,
                    processData: false,
                    contentType: false,
                    cache: false,
                    success: function (response) {
                        console.log(response)
                        if (response.id != null) {
                            location.replace('/home')
                        }
                    },
                    error: function (error) {
                        alert(formData);
                    },
                });
            });





            $(".submitGuestBtn").on("click", function () {
                var formData = new FormData($('#userForm')[0]);
                formData.forEach(function (value, key) {
                    console.log(key, value);
                });

                handleGuestFormSubmission(formData);
            });

            disableFormInputs("#reservationForm input, #reservationForm textarea");

            $(".nationalId").on("keyup", function () {
                var inputValue = $(this).val();
                if (inputValue.length === 14) {
                    checkIfUserExists(inputValue);
                } else {
                }
            });

            function handleGuestFormSubmission(formData) {
                $.ajax({
                    type: "POST",
                    url: "/createGuest",
                    data: formData,
                    processData: false,
                    contentType: false,
                    cache: false,
                    success: function (response) {
                        if (response.id != null) {
                            fillFormInputs(response);

                            disableFormInputs("#userForm input");
                            $(".submitGuestBtn").hide();
                            $("#userForm .nationalId").prop("disabled", true);
                            $("#userForm select").prop("disabled", true);
                            enableFormInputs("#reservationForm input, #reservationForm textarea");
                        } else {
                            enableFormInputs("#userForm input");
                            disableFormInputs("#reservationForm input, #reservationForm textarea");
                            $(".submitGuestBtn").show();
                            resetFormValues("#userForm");
                        }
                    },
                    error: function (error) {
                        console.log(error);
                    },
                });
            }

            function checkIfUserExists(nationalId) {
                $.ajax({
                    type: "GET",
                    url: "/checkIfUserExists/" + nationalId,
                    success: function (response) {
                        if (response.id != null) {
                            fillFormInputs(response);

                            disableFormInputs("#userForm input, #userForm select, #userForm .nationalId");
                            enableFormInputs("#reservationForm input, #reservationForm textarea");
                            $(".submitGuestBtn").hide();
                        } else {
                            enableFormInputs("#userForm input, #userForm select");
                            disableFormInputs("#reservationForm input, #reservationForm textarea");
                            $(".submitGuestBtn").show();
                            // resetFormValues("#reservationForm");
                        }
                    },
                    error: function (error) {
                        console.log(error);
                    },
                });
            }

            function disableFormInputs(selector) {
                $(selector).prop("disabled", true);
            }

            function enableFormInputs(selector) {
                $(selector).prop("disabled", false);
                $('#endedAt').prop("disabled", true);
                $('#advanceAmount').prop("disabled", true);
            }

            function fillFormInputs(response) {
                $("#guestId").val(response.id);
                $("#name").val(response.name);
                $("#mobileNumber").val(response.mobileNumber);
                $("#email").val(response.email);
                $("#nationalId").val(response.nationalId);
                $("#maritalStatus").val(response.maritalStatus);
                $("#age").val(response.age);
            }

            function resetFormValues(formId) {
                $(`${formId} input, ${formId} select, ${formId} textarea`).val(null);
            }


            // Function to check the validation status of all fields
            function checkValidationStatus() {
                var isNationalIdValid = validateNationalId($("#nationalId").val()) && $("#nationalId").val().length > 0;
                var isNameValid = validateName($("#name").val());
                var isMobileNumberValid = validateMobileNumber($("#mobileNumber").val());
                var isEmailValid = validateEmail($("#email").val());

                // Update the disabled state of the submit button
                if (isNationalIdValid && isNameValid && isMobileNumberValid && isEmailValid) {
                    $(".submitGuestBtn").prop("disabled", false);
                } else {
                    $(".submitGuestBtn").prop("disabled", true);
                }
            }

            // Hide error messages initially
            $('.nationalIdErrors, .nameErrors, .mobileNumberErrors, .emailErrors').hide();

            // Event handlers for keyup on each input
            $("#nationalId").on("keyup", function () {
                var nationalId = $(this).val();
                if (validateNationalId(nationalId) && nationalId.length > 0) {
                    $('.nationalIdErrors').hide();
                } else {
                    $('.nationalIdErrors').show();
                }
                checkValidationStatus();
            });

            $("#name").on("keyup", function () {
                var name = $(this).val();
                if (validateName(name)) {
                    $('.nameErrors').hide();
                } else {
                    $('.nameErrors').show();
                }
                checkValidationStatus();
            });

            $("#mobileNumber").on("keyup", function () {
                var mobileNumber = $(this).val();
                if (validateMobileNumber(mobileNumber)) {
                    $('.mobileNumberErrors').hide();
                } else {
                    $('.mobileNumberErrors').show();
                }
                checkValidationStatus();
            });

            $("#email").on("keyup", function () {
                var email = $(this).val();
                if (validateEmail(email)) {
                    $('.emailErrors').hide();
                } else {
                    $('.emailErrors').show();
                }
                checkValidationStatus();
            });

            // Initial validation check
            checkValidationStatus();



            function validateName(name) {
                var arabicRegex = /^[\u0600-\u065F\u066A-\u06EF\u06FA-\u06FF\s]+$/;
                var isValid = arabicRegex.test(name);
                return typeof name === 'string' && name.length >= 4 && name.length <= 100 && isValid;
            }


            function validateMobileNumber(mobileNumber) {
                const mobileNumberRegex = /^\d{11}$/;
                return mobileNumberRegex.test(mobileNumber);
            }

            function validateEmail(email) {
                // Regular expression for a basic email validation
                var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return emailRegex.test(email);
            }

            function validateNationalId(nationalId) {
                const nationalIdRegex = /^\d{14}$/;
                return nationalIdRegex.test(nationalId);
            }
        });








    </script>
</body>

</html>